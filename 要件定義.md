ここまでの議論を基に、Geminiアプリ上で動作するChrome拡張機能の要件定義書をまとめました。

---

### 1. プロジェクト概要

本プロジェクトは、GoogleのAIサービス「Gemini」のWeb UI上で動作するChrome拡張機能の開発です。特定のJSON形式の出力（マークダウンのコードブロック形式）を検知し、それをユーザーが操作可能なインタラクティブなGUIに動的に変換することを目的とします。これにより、ユーザーとGeminiの間で、テキストベースではない、より直感的でリッチなコミュニケーションを実現します。

---

### 2. 機能要件

| ID | 機能名 | 説明 | 備考 |
|:---|:---|:---|:---|
| F-01 | **Gemini出力の検知** | Geminiのチャット出力内で、特定の形式のJSON（マークダウンのコードブロック）を検知する。 | `MutationObserver`を使用し、動的なDOM変更に対応。 |
| F-02 | **JSONのパースと検証** | 検知したJSON文字列を解析し、定義されたスキーマに従っているか検証する。 | 無効なJSONや予期せぬスキーマの場合は処理をスキップ。 |
| F-03 | **HTMLレンダリング** | パースしたJSONデータに基づき、事前に定義されたHTML要素（GUIコンポーネント）を動的に生成する。 | スタイルはGeminiのUIに合わせる。 |
| F-04 | **UIの置き換え** | 生成したHTML要素で、元のJSONコードブロック部分を置き換える。 | 違和感のないUXを実現するため、スムーズに置き換えを行う。 |
| F-05 | **ユーザー操作の検知** | レンダリングされたGUIコンポーネント（ボタン、チェックボックスなど）へのユーザー操作（クリック、入力など）を検知する。 | イベントリスナーを使用。 |
| F-06 | **ユーザーアクションのデータ化** | 検知したユーザー操作を、JSON形式の文字列に変換する。 | 例：`{"user_action": "click", "value": "yes"}` |
| F-07 | **Geminiへのデータ送信** | データ化したJSON文字列を、Geminiのチャット入力フィールドに自動挿入し、送信する。 | DOM操作による入力・送信を実装。 |
| F-08 | **履歴の可視化** | ユーザーが送信したGUIアクションのJSON文字列が、Geminiのチャット履歴にテキストとして残るようにする。 | ユーザーが後から対話内容を振り返れるようにする。 |

---

### 3. 非機能要件

| ID | 要件名 | 説明 | 備考 |
|:---|:---|:---|:---|
| N-01 | **パフォーマンス** | Geminiアプリの応答速度やUIの動作に影響を与えないこと。 | 処理は非同期で行い、軽量なJSON形式を維持する。 |
| N-02 | **安定性** | GeminiのUIがアップデートされても、基本的な機能が継続して動作すること。 | マークダウンのコードブロックを検知するため、DOM構造に依存しすぎない設計とする。 |
| N-03 | **セキュリティ** | ユーザーのプライバシー情報を収集しないこと。 | 拡張機能はローカルで完結し、外部サーバーとの通信は行わない。 |
| N-04 | **ユーザーインターフェース (UI)** | レンダリングされるUIコンポーネントは、GeminiのUIデザインに自然に溶け込むこと。 | フォント、色、レイアウトなどを考慮。 |
| N-05 | **互換性** | Google Chromeの最新バージョンで動作すること。 |
| N-06 | **拡張性** | 将来的に新しいGUIコンポーネント（グラフ、テーブルなど）を追加できる設計とすること。 | JSONスキーマの拡張を可能とする。 |

---

### 4. 採用技術スタック

* **開発言語**: JavaScript
* **Web API**: `MutationObserver`, `document.querySelector`, `addEventListener`など
* **データ形式**: JSON（マークダウンコードブロック形式）
* **デザイン**: CSS（必要に応じて）

---

### 5. GUIコンポーネント一覧

以下に示すGUIコンポーネントは、JSONの`type`プロパティに応じてレンダリングされます。

* **`button_set`**: 複数の選択肢をボタンとして表示する。
* **`radio_group`**: 複数の選択肢から1つを選択させる。
* **`dropdown`**: ドロップダウンリストとして選択肢を表示する。
* **`slider`**: スライダーで数値を選択させる。
* **`text_input`**: テキスト入力フィールドを提供する。
* **`date_picker` / `time_picker`**: 日付・時間選択フィールドを提供する。
* **`image`**: 画像を表示する。
* **`link`**: 外部サイトへのリンクを表示する。
* **`progress_bar`**: 進捗バーを表示する。
* **`list`**: 項目をリスト形式で表示する。

### 6. プロンプト設計の基本原則

Geminiへのプロンプトは、以下の原則に従い、出力形式を厳密にコントロールします。

* **役割の定義**: 「あなたは、GUIコンポーネントを生成する専門家です。」
* **出力の形式指定**: 「出力は、マークダウンのコードブロック内にJSON形式で記述してください。」
* **余計なテキストの排除**: 「JSONコードブロック以外には、いかなる説明や挨拶も追加しないでください。」

この要件定義書は、プロジェクトの初期フェーズにおける基本方針を定めたものです。開発を進める中で、ユーザーからのフィードバックや技術的な制約に基づき、適宜更新・詳細化していく必要があります。